<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>rxjs系列 -- Observale与Observer - WELCOME TO HERE!</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com"><span>Github</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://callfiles.ueibo.com/hexo-theme-laughing/post_background.jpg"><div class="post-title"><h1 class="title">rxjs系列 -- Observale与Observer</h1><ul class="meta"><li><i class="icon icon-author"></i>菜鸡蟹</li><li><i class="icon icon-clock"></i><!-- #{parseInt(page.content ? page.content.length/900 : 0)} Minutes-->34 Days</li><li><i class="icon icon-calendar"></i>June 23, 2019</li></ul></div></div><div class="article-content" style="max-width:800px"><p>在RxJS中，一个数据流的完整流向至少需要包含Observable和Observer。Observable是被观察者，Observer是观察者，Observer订阅Observable，Observable向Observer推送数据以完成整个过程。</p>
<p>可以说一个完整的RxJS数据流就是Observable和Observer之间的互动游戏。</p>
<p>Observable实现了下⾯两种设计模式：</p>
<ul>
<li>观察者模式</li>
<li>迭代器模式</li>
</ul>
<p>由于不是写设计模式的文章，所以一笔带过，感兴趣的可以自己看下相关的书，需要一提的是，任何⼀种设计模式，指的都是解决某⼀个特定类型问题的⽅法。问题复杂多变，往往不是靠单独⼀种设计模式能够解决的，更需要多种设计模式的组合，而RxJS的Observable就是观察者模式和迭代器模式的组合。</p>
<h1 id="Observale与Observer的互动"><a href="#Observale与Observer的互动" class="headerlink" title="Observale与Observer的互动"></a>Observale与Observer的互动</h1><h2 id="订阅"><a href="#订阅" class="headerlink" title="订阅"></a>订阅</h2><p>首先我们先创建一个Observable，作为数据源<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Observable &#125; = rxjs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sourceObservable$ = <span class="keyword">new</span> Observable(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    observer.next(<span class="string">'hello'</span>);</span><br><span class="line">    observer.next(<span class="string">'rxjs'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>然后再设置一个observer，作为订阅者<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Observer = &#123;</span><br><span class="line">    next: <span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>最后Observer订阅Observable，数据开始流动<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sourceObservable$.subscribe(Observer);</span><br><span class="line"><span class="comment">// hello</span></span><br><span class="line"><span class="comment">// rxjs</span></span><br></pre></td></tr></table></figure></p>
<p>一个非常简单的数据流就完成了。</p>
<h2 id="状态流转"><a href="#状态流转" class="headerlink" title="状态流转"></a>状态流转</h2><p>在上面的例子中，只有next这一种状态，不断地往下游传递数据，但实际上，数据流在流动过程中有三种状态：</p>
<ul>
<li>next，正常流转到下一个状态</li>
<li>error，捕获到异常，流动中止</li>
<li>complete，数据流已经完成，流动终止</li>
</ul>
<p>接下来改一下上面的代码，补上另外两种状态<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sourceObservable$ = <span class="keyword">new</span> Observable(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    observer.next(<span class="string">'hello'</span>);</span><br><span class="line">    observer.error(<span class="string">'the data is wrong!'</span>);</span><br><span class="line">    observer.next(<span class="string">'rxjs'</span>);</span><br><span class="line">    observer.complete();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Observer = &#123;</span><br><span class="line">    next: <span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res),</span><br><span class="line">    error: <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err),</span><br><span class="line">    complete: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'complete!'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sourceObservable$.subscribe(Observer);</span><br><span class="line"><span class="comment">// hello</span></span><br><span class="line"><span class="comment">// the data is wrong!</span></span><br></pre></td></tr></table></figure></p>
<p>现在再看Observer是不是有种似曾相识的感觉？没错，Observer其实就是一个迭代器了。</p>
<p>至此，不难发现，Observable与Observer的互动过程其实就是，Observer通过观察者模式向Observable注入了一个迭代器，通过next游标控制数据源Observable的数据流动，并根据实际流动过程中可能发生的情况将状态流转到error或者complete。</p>
<h2 id="取消订阅"><a href="#取消订阅" class="headerlink" title="取消订阅"></a>取消订阅</h2><p>现在Observable与Observer已经通过subscribe建立了联系，但有时候我们需要把这种联系断开，比如组件销毁的时候。这时候就需要取消订阅了，看下面的例子<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sourceObservable$ = <span class="keyword">new</span> Observable(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="number">1</span>;</span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        observer.next(number++);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Observer = &#123;</span><br><span class="line">    next: <span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res),</span><br><span class="line">    error: <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err),</span><br><span class="line">    complete: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'complete!'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> subscription = sourceObservable$.subscribe(Observer);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 取消订阅</span></span><br><span class="line">    subscription.unsubscribe();</span><br><span class="line">&#125;, <span class="number">4000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br></pre></td></tr></table></figure></p>
<p>需要注意的是，在本例子中，虽然取消订阅了，但是作为数据源的sourceObservable$并没有终结，因为始终没有调用complete方法，只是Observer不再接收推送的数据了</p>
<p>为了便于观察其中的差异，我们将sourceObservable$改一下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sourceObservable$ = <span class="keyword">new</span> Observable(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="number">1</span>;</span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'subscribe:'</span> + number);</span><br><span class="line">        observer.next(number++);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// subscribe: 1</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// subscribe: 2</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// subscribe: 3</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// subscribe: 4</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// subscribe: 5</span></span><br><span class="line"><span class="comment">// subscribe: 6</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Hot-Observable和Cold-Observable"><a href="#Hot-Observable和Cold-Observable" class="headerlink" title="Hot Observable和Cold Observable"></a>Hot Observable和Cold Observable</h1><p>假设我们有这样一个场景，一个Observable被两个ObserverA、ObserverB先后相隔N秒订阅了，那么ObserverB是否需要接收订阅之前的数据呢？</p>
<p>其实没有固定的答案，是否接收需要根据实际的业务场景来定，正是因为如此，所以便有了Hot Observable以及Cold Observable。</p>
<ul>
<li>Hot Observable：热被观察对象，类似于直播，看到的内容是从你打开直播的那一刻开始的，之前的内容已经错过。只能接收订阅那一刻开始的数据。</li>
<li>Cold Observable：冷被观察对象，类似于录播，看到的内容是你打开的视频的第一秒种开始的。每次订阅都会从头开始接收数据</li>
</ul>
<p>先看下Hot Observable，每次订阅只推送当前的数据，所以不会在每次订阅时重置数据推送，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先产生数据</span></span><br><span class="line"><span class="keyword">let</span> number = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sourceObservale$ = <span class="keyword">new</span> Observable(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> num = number;</span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        observer.next(num++);</span><br><span class="line">        number = num;</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ObserverA = ObserverB = &#123;</span><br><span class="line">    next: <span class="function"><span class="params">item</span> =&gt;</span> <span class="built_in">console</span>.log(item),</span><br><span class="line">    error: <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err),</span><br><span class="line">    complete: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'complete!'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sourceObservale$.subscribe(ObserverA);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    sourceObservale$.subscribe(ObserverB);</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1 =&gt; A</span></span><br><span class="line"><span class="comment">// 2 =&gt; A</span></span><br><span class="line"><span class="comment">// 3 =&gt; A</span></span><br><span class="line"><span class="comment">// 3 =&gt; B</span></span><br><span class="line"><span class="comment">// 4 =&gt; A</span></span><br><span class="line"><span class="comment">// 4 =&gt; B</span></span><br><span class="line"><span class="comment">// ..</span></span><br></pre></td></tr></table></figure></p>
<p>而对于Cold Observable，每次订阅都是重头开始推送，所以每一次订阅都会重置数据推送，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sourceObservale$ = <span class="keyword">new</span> Observable(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 订阅时产生数据</span></span><br><span class="line">    <span class="keyword">let</span> number = <span class="number">1</span>;</span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        observer.next(number++);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间不变</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1 =&gt; A</span></span><br><span class="line"><span class="comment">// 2 =&gt; A</span></span><br><span class="line"><span class="comment">// 3 =&gt; A</span></span><br><span class="line"><span class="comment">// 1 =&gt; B</span></span><br><span class="line"><span class="comment">// 4 =&gt; A</span></span><br><span class="line"><span class="comment">// 2 =&gt; B</span></span><br><span class="line"><span class="comment">// ..</span></span><br></pre></td></tr></table></figure></p>
<p>从这里也可以看出，Observable是具有惰性求值的，只有在被订阅的时候才会执行内部逻辑，而Cold Observable则更进一步，在没有被订阅的时候，连数据都不会产生。</p>
</div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/rxjs/">rxjs</a><span class="tag-list-count">3</span></li></ul></div><div class="categories"><i class="icon icon-category"></i><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a><span class="category-list-count">2</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/rxjs-introduction/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://weibo.com" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li><li><a href="https://www.segmentfault.com" title="SegmentFault" target="_blank"><i class="icon icon-segmentfault"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2019 WELCOME TO HERE!<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>